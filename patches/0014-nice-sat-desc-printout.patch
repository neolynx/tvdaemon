From ee136d13af50a0e98af76a5571268b94a81c22b2 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andr=C3=A9=20Roth?= <neolynx@gmail.com>
Date: Sat, 9 Jun 2012 01:00:45 +0200
Subject: [PATCH 14/15] nice sat desc printout

---
 lib/include/descriptors.h           |    9 ++++++++-
 lib/include/descriptors/nit.h       |    4 ++++
 lib/libdvbv5/descriptors/desc_sat.c |   29 +++++++++++++++++++++--------
 3 files changed, 33 insertions(+), 9 deletions(-)

diff --git a/lib/include/descriptors.h b/lib/include/descriptors.h
index 1c24d1e..0998bda 100644
--- a/lib/include/descriptors.h
+++ b/lib/include/descriptors.h
@@ -55,8 +55,15 @@ struct dvb_desc {
 	uint8_t data[];
 } __attribute__((packed));
 
+#define dvb_desc_foreach( desc, tbl ) \
+	for( struct dvb_desc *desc = tbl->descriptor; desc; desc = desc->next ) \
+
+#define dvb_desc_find(_struct, _desc, _tbl, _type) \
+	_struct *_desc = (_struct *) _tbl->descriptor; \
+	while(_desc && _desc->type != _type) \
+		_desc = (_struct *) _desc->next;
+
 void dvb_desc_init(const uint8_t **buf, struct dvb_desc *desc);
-int bcd_to_int(const unsigned char *bcd, int bits);
 uint32_t bcd(uint32_t bcd);
 
 ssize_t dvb_parse_descriptor(const uint8_t *buf, uint8_t *dest, uint16_t section_length, struct dvb_desc **head_desc);
diff --git a/lib/include/descriptors/nit.h b/lib/include/descriptors/nit.h
index 4ccafe9..796e4e2 100644
--- a/lib/include/descriptors/nit.h
+++ b/lib/include/descriptors/nit.h
@@ -66,6 +66,10 @@ struct dvb_table_nit {
 	struct dvb_table_nit_transport *transport;
 } __attribute__((packed));
 
+
+#define dvb_nit_transport_foreach( tran, nit ) \
+  for( struct dvb_table_nit_transport *tran = nit->transport; tran; tran = tran->next ) \
+
 struct dvb_v5_fe_parms;
 
 #ifdef __cplusplus
diff --git a/lib/libdvbv5/descriptors/desc_sat.c b/lib/libdvbv5/descriptors/desc_sat.c
index f7b0806..b658b15 100644
--- a/lib/libdvbv5/descriptors/desc_sat.c
+++ b/lib/libdvbv5/descriptors/desc_sat.c
@@ -34,6 +34,7 @@ ssize_t dvb_desc_sat_init(const uint8_t **buf, struct dvb_desc *desc)
 	bswap16(sat->orbit);
 	bswap32(sat->bitfield);
 	bswap32(sat->frequency);
+	sat->orbit = bcd(sat->orbit);
 	sat->frequency   = bcd(sat->frequency) * 10;
 	sat->symbol_rate = bcd(sat->symbol_rate) * 100;
 
@@ -44,15 +45,27 @@ ssize_t dvb_desc_sat_init(const uint8_t **buf, struct dvb_desc *desc)
 void dvb_desc_sat_print(struct dvb_v5_fe_parms *parms, const struct dvb_desc *desc)
 {
 	const struct dvb_desc_sat *sat = (const struct dvb_desc_sat *) desc;
-	dvb_log("|           length            %d", sat->length);
-	dvb_log("|           frequency         %d", sat->frequency);
-	dvb_log("|           orbit             %d", sat->orbit);
+	char pol;
+	switch(sat->polarization) {
+		case 0:
+			pol = 'H';
+			break;
+		case 1:
+			pol = 'V';
+			break;
+		case 2:
+			pol = 'L';
+			break;
+		case 3:
+			pol = 'R';
+			break;
+	}
+	dvb_log("|           modulation_system %s", sat->modulation_system ? "DVB-S2" : "DVB-S");
+	dvb_log("|           frequency         %d %c", sat->frequency, pol);
+	dvb_log("|           symbol_rate       %d", sat->symbol_rate);
+	dvb_log("|           fec               %d", sat->fec);
 	dvb_log("|           modulation_type   %d", sat->modulation_type);
-	dvb_log("|           modulation_system %d", sat->modulation_system);
 	dvb_log("|           roll_off          %d", sat->roll_off);
-	dvb_log("|           polarization      %d", sat->polarization);
-	dvb_log("|           west_east         %d", sat->west_east);
-	dvb_log("|           fec               %d", sat->fec);
-	dvb_log("|           symbol_rate       %d", sat->symbol_rate);
+	dvb_log("|           orbit             %.1f %c", (float) sat->orbit / 10.0, sat->west_east ? 'E' : 'W');
 }
 
-- 
1.7.9.5

