From 5b41e2af493851c0805834318d5276ad4e6f318b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andr=C3=A9=20Roth?= <neolynx@gmail.com>
Date: Sun, 9 Feb 2014 15:04:02 +0100
Subject: [PATCH 28/37] fix pes parser

---
 lib/include/libdvbv5/mpeg_pes.h     |  2 +-
 lib/libdvbv5/descriptors/mpeg_pes.c | 58 ++++++++++++++++++++-----------------
 2 files changed, 32 insertions(+), 28 deletions(-)

diff --git a/lib/include/libdvbv5/mpeg_pes.h b/lib/include/libdvbv5/mpeg_pes.h
index 3a3f8e4..5889df7 100644
--- a/lib/include/libdvbv5/mpeg_pes.h
+++ b/lib/include/libdvbv5/mpeg_pes.h
@@ -100,7 +100,7 @@ struct dvb_v5_fe_parms;
 extern "C" {
 #endif
 
-void dvb_mpeg_pes_init (struct dvb_v5_fe_parms *parms, const uint8_t *buf, ssize_t buflen, uint8_t *table, ssize_t *table_length);
+ssize_t dvb_mpeg_pes_init (struct dvb_v5_fe_parms *parms, const uint8_t *buf, ssize_t buflen, uint8_t *table);
 void dvb_mpeg_pes_free(struct dvb_mpeg_pes *ts);
 void dvb_mpeg_pes_print(struct dvb_v5_fe_parms *parms, struct dvb_mpeg_pes *ts);
 
diff --git a/lib/libdvbv5/descriptors/mpeg_pes.c b/lib/libdvbv5/descriptors/mpeg_pes.c
index 65f5cf1..be2a6c1 100644
--- a/lib/libdvbv5/descriptors/mpeg_pes.c
+++ b/lib/libdvbv5/descriptors/mpeg_pes.c
@@ -22,20 +22,22 @@
 #include <libdvbv5/descriptors.h>
 #include <libdvbv5/dvb-fe.h>
 
-void dvb_mpeg_pes_init(struct dvb_v5_fe_parms *parms, const uint8_t *buf, ssize_t buflen, uint8_t *table, ssize_t *table_length)
+ssize_t dvb_mpeg_pes_init(struct dvb_v5_fe_parms *parms, const uint8_t *buf, ssize_t buflen, uint8_t *table)
 {
-	struct dvb_mpeg_pes *pes = (struct dvb_mpeg_pes *) (table + *table_length);
+	struct dvb_mpeg_pes *pes = (struct dvb_mpeg_pes *) table;
 	const uint8_t *p = buf;
-	memcpy(table + *table_length, p, sizeof(struct dvb_mpeg_pes));
+	ssize_t bytes_read = 0;
+
+	memcpy(table, p, sizeof(struct dvb_mpeg_pes));
 	p += sizeof(struct dvb_mpeg_pes);
-	*table_length += sizeof(struct dvb_mpeg_pes);
+	bytes_read += sizeof(struct dvb_mpeg_pes);
 
 	bswap32(pes->bitfield);
 	bswap16(pes->length);
 
 	if (pes->sync != 0x000001) {
 		dvb_logerr("mpeg pes invalid, sync 0x%06x should be 0x000001", pes->sync);
-		return;
+		return -1;
 	}
 
 	if (pes->stream_id == DVB_MPEG_STREAM_PADDING) {
@@ -48,6 +50,7 @@ void dvb_mpeg_pes_init(struct dvb_v5_fe_parms *parms, const uint8_t *buf, ssize_
 		   pes->stream_id == DVB_MPEG_STREAM_DSMCC ||
 		   pes->stream_id == DVB_MPEG_STREAM_H222E ) {
 		dvb_logerr("mpeg pes: unsupported stream type 0x%04x", pes->stream_id);
+		return -2;
 	} else {
 		memcpy(pes->optional, p, sizeof(struct dvb_mpeg_pes_optional) -
 					 sizeof(pes->optional->pts) -
@@ -82,8 +85,9 @@ void dvb_mpeg_pes_init(struct dvb_v5_fe_parms *parms, const uint8_t *buf, ssize_
 			pes->optional->dts |= (uint64_t) dts.bits15 << 15;
 			pes->optional->dts |= (uint64_t) dts.bits30 << 30;
 		}
-		*table_length += sizeof(struct dvb_mpeg_pes_optional);
+		bytes_read += sizeof(struct dvb_mpeg_pes_optional);
 	}
+	return bytes_read;
 }
 
 void dvb_mpeg_pes_free(struct dvb_mpeg_pes *ts)
@@ -93,10 +97,10 @@ void dvb_mpeg_pes_free(struct dvb_mpeg_pes *ts)
 
 void dvb_mpeg_pes_print(struct dvb_v5_fe_parms *parms, struct dvb_mpeg_pes *pes)
 {
-	dvb_log("MPEG PES");
-	dvb_log(" - sync      0x%08x", pes->sync);
-	dvb_log(" - stream_id 0x%04x", pes->stream_id);
-	dvb_log(" - length    %d", pes->length);
+	dvb_loginfo("MPEG PES");
+	dvb_loginfo(" - sync    0x%06x", pes->sync);
+	dvb_loginfo(" - stream_id 0x%04x", pes->stream_id);
+	dvb_loginfo(" - length      %d", pes->length);
 	if (pes->stream_id == DVB_MPEG_STREAM_PADDING) {
 	} else if (pes->stream_id == DVB_MPEG_STREAM_MAP ||
 		   pes->stream_id == DVB_MPEG_STREAM_PRIVATE_2 ||
@@ -107,25 +111,25 @@ void dvb_mpeg_pes_print(struct dvb_v5_fe_parms *parms, struct dvb_mpeg_pes *pes)
 		   pes->stream_id == DVB_MPEG_STREAM_H222E ) {
 		dvb_log("  mpeg pes unsupported stream type 0x%04x", pes->stream_id);
 	} else {
-		dvb_log("  mpeg pes optional");
-		dvb_log("   - two                      %d", pes->optional->two);
-		dvb_log("   - PES_scrambling_control   %d", pes->optional->PES_scrambling_control);
-		dvb_log("   - PES_priority             %d", pes->optional->PES_priority);
-		dvb_log("   - data_alignment_indicator %d", pes->optional->data_alignment_indicator);
-		dvb_log("   - copyright                %d", pes->optional->copyright);
-		dvb_log("   - original_or_copy         %d", pes->optional->original_or_copy);
-		dvb_log("   - PTS_DTS                  %d", pes->optional->PTS_DTS);
-		dvb_log("   - ESCR                     %d", pes->optional->ESCR);
-		dvb_log("   - ES_rate                  %d", pes->optional->ES_rate);
-		dvb_log("   - DSM_trick_mode           %d", pes->optional->DSM_trick_mode);
-		dvb_log("   - additional_copy_info     %d", pes->optional->additional_copy_info);
-		dvb_log("   - PES_CRC                  %d", pes->optional->PES_CRC);
-		dvb_log("   - PES_extension            %d", pes->optional->PES_extension);
-		dvb_log("   - length                   %d", pes->optional->length);
+		dvb_loginfo("  mpeg pes optional");
+		dvb_loginfo("   - two                      %d", pes->optional->two);
+		dvb_loginfo("   - PES_scrambling_control   %d", pes->optional->PES_scrambling_control);
+		dvb_loginfo("   - PES_priority             %d", pes->optional->PES_priority);
+		dvb_loginfo("   - data_alignment_indicator %d", pes->optional->data_alignment_indicator);
+		dvb_loginfo("   - copyright                %d", pes->optional->copyright);
+		dvb_loginfo("   - original_or_copy         %d", pes->optional->original_or_copy);
+		dvb_loginfo("   - PTS_DTS                  %d", pes->optional->PTS_DTS);
+		dvb_loginfo("   - ESCR                     %d", pes->optional->ESCR);
+		dvb_loginfo("   - ES_rate                  %d", pes->optional->ES_rate);
+		dvb_loginfo("   - DSM_trick_mode           %d", pes->optional->DSM_trick_mode);
+		dvb_loginfo("   - additional_copy_info     %d", pes->optional->additional_copy_info);
+		dvb_loginfo("   - PES_CRC                  %d", pes->optional->PES_CRC);
+		dvb_loginfo("   - PES_extension            %d", pes->optional->PES_extension);
+		dvb_loginfo("   - length                   %d", pes->optional->length);
 		if (pes->optional->PTS_DTS & 2)
-			dvb_log("   - pts                      %lx (%fs)", pes->optional->pts, (float) pes->optional->pts / 90000.0);
+			dvb_loginfo("   - pts                      %lx (%fs)", pes->optional->pts, (float) pes->optional->pts / 90000.0);
 		if (pes->optional->PTS_DTS & 1)
-			dvb_log("   - dts                      %lx (%fs)", pes->optional->dts, (float) pes->optional->dts/ 90000.0);
+			dvb_loginfo("   - dts                      %lx (%fs)", pes->optional->dts, (float) pes->optional->dts/ 90000.0);
 	}
 }
 
-- 
1.8.3.2

