From 60c6e26b603ca2fd470ccacbe0ad8e3b57823d62 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andr=C3=A9=20Roth?= <neolynx@gmail.com>
Date: Mon, 10 Feb 2014 19:38:51 +0100
Subject: [PATCH 38/40] fix parse descriptors

---
 lib/libdvbv5/descriptors/pmt.c |   28 ++++++++++++++--------------
 lib/libdvbv5/descriptors/sdt.c |   18 ++++++++++--------
 2 files changed, 24 insertions(+), 22 deletions(-)

diff --git a/lib/libdvbv5/descriptors/pmt.c b/lib/libdvbv5/descriptors/pmt.c
index 9d8b64d..9289b0d 100644
--- a/lib/libdvbv5/descriptors/pmt.c
+++ b/lib/libdvbv5/descriptors/pmt.c
@@ -59,15 +59,15 @@ ssize_t dvb_table_pmt_init(struct dvb_v5_fe_parms *parms, const uint8_t *buf,
 
 		/* parse the descriptors */
 		if (pmt->desc_length > 0 ) {
-			size = pmt->desc_length;
-			if (p + size > endbuf) {
-				dvb_logwarn("%s: decsriptors short read %zd/%zd bytes", __func__,
-					   size, endbuf - p);
-				size = endbuf - p;
+			uint16_t desc_length = pmt->desc_length;
+			if (p + desc_length > endbuf) {
+				dvb_logwarn("%s: decsriptors short read %d/%zd bytes", __func__,
+					   desc_length, endbuf - p);
+				desc_length = endbuf - p;
 			}
-			dvb_parse_descriptors(parms, p, size,
+			dvb_parse_descriptors(parms, p, desc_length,
 					      &pmt->descriptor);
-			p += size;
+			p += desc_length;
 		}
 	}
 
@@ -91,16 +91,16 @@ ssize_t dvb_table_pmt_init(struct dvb_v5_fe_parms *parms, const uint8_t *buf,
 
 		/* parse the descriptors */
 		if (stream->desc_length > 0) {
-			size = stream->desc_length;
-			if (p + size > endbuf) {
-				dvb_logwarn("%s: decsriptors short read %zd/%zd bytes", __func__,
-					   size, endbuf - p);
-				size = endbuf - p;
+			uint16_t desc_length = stream->desc_length;
+			if (p + desc_length > endbuf) {
+				dvb_logwarn("%s: decsriptors short read %d/%zd bytes", __func__,
+					   desc_length, endbuf - p);
+				desc_length = endbuf - p;
 			}
-			dvb_parse_descriptors(parms, p, size,
+			dvb_parse_descriptors(parms, p, desc_length,
 					      &stream->descriptor);
 
-			p += size;
+			p += desc_length;
 		}
 	}
 	if (p < endbuf)
diff --git a/lib/libdvbv5/descriptors/sdt.c b/lib/libdvbv5/descriptors/sdt.c
index bc53403..50f465a 100644
--- a/lib/libdvbv5/descriptors/sdt.c
+++ b/lib/libdvbv5/descriptors/sdt.c
@@ -73,16 +73,18 @@ ssize_t dvb_table_sdt_init(struct dvb_v5_fe_parms *parms, const uint8_t *buf,
 		head = &(*head)->next;
 
 		/* parse the descriptors */
-		size = service->desc_length;
-		if (p + size > endbuf) {
-			dvb_logwarn("%s: decsriptors short read %zd/%zd bytes", __func__,
-				   size, endbuf - p);
-			size = endbuf - p;
+		uint16_t desc_length = service->desc_length;
+		if (p + desc_length > endbuf) {
+			dvb_logwarn("%s: decsriptors short read %d/%zd bytes", __func__,
+				   desc_length, endbuf - p);
+			desc_length = endbuf - p;
+		}
+		if (dvb_parse_descriptors(parms, p, desc_length,
+				      &service->descriptor) != 0) {
+			return -2;
 		}
-		dvb_parse_descriptors(parms, p, size,
-				      &service->descriptor);
 
-		p += size;
+		p += desc_length;
 	}
 	if (endbuf - p)
 		dvb_logwarn("%s: %zu spurious bytes at the end",
-- 
1.7.10.4

